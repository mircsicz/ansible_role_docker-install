version: '3'

vars:
  VERSION_LOG: dryrun.log

tasks:

  release:dry-run:
    desc: Run semantic-release in dry-run mode and log output
    cmds:
      - |
        if [ ! -f .env ]; then
          echo "âŒ .env file not found. Please create one with GITHUB_TOKEN=..."
          exit 1
        fi
        export $(grep -v '^#' .env | xargs)
        echo "ğŸ” Running dry-run..."
        npx semantic-release --dry-run | tee {{.VERSION_LOG}}

  release:parse-version:
    desc: Parse next version from dryrun.log
    cmds:
      - |
        if [ ! -f {{.VERSION_LOG}} ]; then
          echo "âŒ {{.VERSION_LOG}} not found. Run release:dry-run first."
          exit 1
        fi
        VERSION=$(grep -Eo "The next release version is [v0-9]+\.[0-9]+\.[0-9]+" {{.VERSION_LOG}} | tail -1 | awk '{ print $6 }')
        if [ -n "$VERSION" ]; then
          echo "âœ… Next version: $VERSION"
        else
          echo "âš ï¸ Could not extract version."
        fi

  release:tag:
    desc: Create and push Git tag from parsed version
    cmds:
      - |
        VERSION=$(grep -Eo "The next release version is [v0-9]+\.[0-9]+\.[0-9]+" {{.VERSION_LOG}} | tail -1 | awk '{ print $6 }')
        if [ -z "$VERSION" ]; then
          echo "âŒ No version found. Run release:dry-run first."
          exit 1
        fi
        echo "ğŸ·ï¸ Tagging $VERSION"
        git tag "$VERSION"
        git push origin "$VERSION"

  release:changelog:
    desc: Generate or update CHANGELOG.md from git tags
    cmds:
      - |
        if ! command -v conventional-changelog &> /dev/null; then
          echo "âš ï¸ 'conventional-changelog' not installed."
          read -p "ğŸ‘‰ Install now via npm? [y/N]: " confirm
          if [[ "$confirm" =~ ^[Yy]$ ]]; then
            npm install -g conventional-changelog-cli
          else
            echo "âŒ Aborted."
            exit 1
          fi
        fi
        conventional-changelog -p angular -i CHANGELOG.md -s -r 0
        echo "âœ… CHANGELOG.md updated."

  release:all:
    desc: Run full release sequence (dry-run â†’ parse â†’ tag â†’ changelog)
    deps:
      - release:dry-run
      - release:parse-version
      - release:tag
      - release:changelog
  
  release:debug-token:
    desc: Run semantic-release locally with current GITHUB_TOKEN to test token permissions
    cmds:
      - |
        if [ ! -f .env ]; then
          echo "âŒ .env file not found. Please create one with GITHUB_TOKEN=..."
          exit 1
        fi
        export $(grep -v '^#' .env | xargs)
        echo "ğŸ” Testing semantic-release with token: $GITHUB_TOKEN"
        npx semantic-release --dry-run || echo "âŒ Token test failed."

  release:whoami:
    desc: Show GitHub user and repo info using GITHUB_TOKEN
    cmds:
      - |
        if [ ! -f .env ]; then
          echo "âŒ .env file not found. Please create one with GITHUB_TOKEN=..."
          exit 1
        fi
        export $(grep -v '^#' .env | xargs)

        echo "ğŸ” Using GITHUB_TOKEN: checking identity..."
        curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user | jq '{login, id, html_url}'
        
        echo "ğŸ“¦ Listing accessible repos..."
        curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user/repos?per_page=100 | jq '.[].full_name'

  setup.dependencies:
    desc: Install project dependencies (semantic-release + changelog-cli)
    cmds:
      - |
        if ! command -v node &> /dev/null; then
          echo "âŒ Node.js is not installed. Please install Node.js first."
          exit 1
        fi

        echo "ğŸ“¦ Installing semantic-release..."
        npm install --save-dev semantic-release

        if ! command -v conventional-changelog &> /dev/null; then
          echo "ğŸ“¦ Installing conventional-changelog-cli globally..."
          npm install -g conventional-changelog-cli
        else
          echo "âœ… conventional-changelog-cli already installed."
        fi

        echo "âœ… Dependency setup complete."

  setup.env:
    desc: Create or update .env file with GITHUB_TOKEN
    cmds:
      - |
        echo "ğŸ”§ Setting up .env with GITHUB_TOKEN"

        if [ -f .env ]; then
          echo "âš ï¸  .env already exists."
          read -p "ğŸ‘‰ Overwrite existing .env file? [y/N]: " overwrite
          if [[ ! "$overwrite" =~ ^[Yy]$ ]]; then
            echo "âŒ Aborted."
            exit 0
          fi
        fi

        read -s -p "ğŸ” Enter your GitHub Token: " token
        echo ""
        echo "GITHUB_TOKEN=$token" > .env

        echo "âœ… .env created/updated."
        echo "ğŸ“‚ Contents (masked):"
        echo "GITHUB_TOKEN=ghp_$(echo "$token" | cut -c5-8)****$(echo "$token" | rev | cut -c1-4 | rev)"

  setup.npm:
    desc: Initialize package.json and install semantic-release
    cmds:
      - |
        if ! command -v node &> /dev/null; then
          echo "âŒ Node.js is not installed. Please install Node.js first."
          exit 1
        fi

        if [ ! -f package.json ]; then
          echo "ğŸ“¦ Creating package.json..."
          npm init -y > /dev/null
        else
          echo "ğŸ“¦ package.json already exists."
        fi

        echo "ğŸ“¦ Installing semantic-release..."
        npm install --save-dev semantic-release

        if ! command -v conventional-changelog &> /dev/null; then
          echo "ğŸ“¦ Installing conventional-changelog-cli globally..."
          npm install -g conventional-changelog-cli
        else
          echo "âœ… conventional-changelog-cli already installed."
        fi

        echo "âœ… NPM setup complete."

  setup.verify:
    desc: Verify environment, tools, token and project config
    cmds:
      - |
        echo "ğŸ” Verifying environment..."

        echo "ğŸ”§ Node.js:"
        node -v || echo "âŒ Node.js not found"

        echo "ğŸ“¦ npm:"
        npm -v || echo "âŒ npm not found"

        echo "ğŸ“¦ semantic-release:"
        npx semantic-release --version || echo "âŒ semantic-release not installed"

        echo "ğŸ“¦ conventional-changelog-cli:"
        if command -v conventional-changelog &> /dev/null; then
          echo "âœ… conventional-changelog-cli installed"
        else
          echo "âŒ conventional-changelog-cli missing"
        fi

        echo "ğŸ“‚ .env file:"
        if [ -f .env ]; then
          echo "âœ… .env found"
        else
          echo "âŒ .env missing"
        fi

        echo "ğŸ“¦ package.json:"
        if [ -f package.json ]; then
          echo "âœ… package.json found"
        else
          echo "âŒ package.json missing"
        fi

  setup.clean:
    desc: Remove local config and node_modules for clean start
    cmds:
      - |
        echo "ğŸ§¼ Cleaning project..."
        rm -f .env
        rm -rf node_modules
        rm -f package-lock.json
        rm -f dryrun.log
        echo "âœ… Clean complete."

  setup.all:
    desc: Run full setup (env + npm + dependencies + verify)
    deps:
      - setup.env
      - setup.npm
      - setup.dependencies
      - setup.verify

  setup.minimal:
    desc: Minimal setup (env + verify only)
    deps:
      - setup.env
      - setup.verify
